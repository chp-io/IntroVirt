CMAKE_MINIMUM_REQUIRED(VERSION 3.10)

PROJECT(libintrovirt1)

# gitversion.h is a generated file
SET_SOURCE_FILES_PROPERTIES(${CMAKE_CURRENT_BINARY_DIR}/../gitversion.h
    PROPERTIES GENERATED TRUE
    HEADER_FILE_ONLY TRUE)

FILE(GLOB CONFIG_FILES "../conf/*")
FILE(GLOB_RECURSE SOURCES "*.cc")

ADD_LIBRARY(introvirt SHARED ${GENERATED_SOURCES} ${SOURCES} ${CMAKE_CURRENT_BINARY_DIR}/../gitversion.h)
ADD_DEPENDENCIES(introvirt generate_syscalls)

SET_SOURCE_FILES_PROPERTIES(${GENERATED_SOURCES} PROPERTIES GENERATED TRUE)

TARGET_LINK_LIBRARIES(introvirt boost_filesystem)
TARGET_LINK_LIBRARIES(introvirt log4cxx)
TARGET_LINK_LIBRARIES(introvirt mspdb)
TARGET_LINK_LIBRARIES(introvirt stdc++)
TARGET_LINK_LIBRARIES(introvirt stdc++fs)

# I only have confidence in LTO on gcc-9.1+
IF (CMAKE_BUILD_TYPE STREQUAL "Release")
  IF (CMAKE_CXX_COMPILER_ID STREQUAL "GNU")
    IF (CMAKE_CXX_COMPILER_VERSION VERSION_GREATER_EQUAL 9.1)
        MESSAGE(STATUS "Enabling link-time optimizations")
      SET_PROPERTY(TARGET introvirt PROPERTY INTERPROCEDURAL_OPTIMIZATION TRUE)
    ENDIF()
  ENDIF()
ENDIF()

INSTALL(TARGETS introvirt LIBRARY DESTINATION lib COMPONENT libintrovirt1)
IF( NOT NO_INSTALL_CONF_FILES )
    INSTALL(FILES ${CONFIG_FILES} DESTINATION /etc/introvirt COMPONENT libintrovirt1)
ENDIF()

#GET_PROPERTY(TARGET_LIBS TARGET introvirt PROPERTY LOCATION)
